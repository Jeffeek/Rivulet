name: Test Diagnostics (Find Hanging Tests)

on:
  workflow_dispatch: # Manual trigger
  pull_request:
    branches: [ master ]

jobs:
  test-with-diagnostics:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Overall job timeout

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          8.0.x
          9.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Run tests with hang detection
      run: |
        dotnet test \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "console;verbosity=detailed" \
          --blame-hang-timeout 120000 \
          --blame-hang-dump-type full \
          --results-directory ./TestResults \
          -- xUnit.MaxParallelThreads=4
      timeout-minutes: 10
      continue-on-error: true

    - name: Upload hang dumps on timeout
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: hang-dumps
        path: |
          ./TestResults/**/*.dmp
          ./TestResults/**/*.log
          ./TestResults/**/Sequence_*.xml
        retention-days: 7

    - name: Show last 100 lines of test output
      if: always()
      run: |
        echo "=== Last 100 lines of test execution ==="
        tail -n 100 ./TestResults/**/*.log || echo "No logs found"
