name: Reusable Flaky Test Detection

on:
  workflow_call:
    inputs:
      iterations:
        description: 'Number of test iterations to run'
        required: true
        type: number
        default: 20
      timeout-minutes:
        description: 'Timeout in minutes (recommended: iterations * 3, e.g., 50 iterations = 150 minutes)'
        required: false
        type: number
        default: 100

permissions:
  contents: read

jobs:
  detect-flaky-tests:
    name: Detect Flaky Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
      fail-fast: false

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
      with:
        dotnet-version: 9.0.x

    - name: Cache NuGet packages
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: ~/.nuget/packages  # Cross-platform: works on Windows, Linux, and macOS
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore NuGet packages
      run: dotnet restore

    - name: Build solution (Release)
      run: dotnet build -c Release --no-restore

    - name: Run flaky test detection - Windows
      if: runner.os == 'Windows'
      shell: pwsh
      run: ./scripts/run-flaky-test-detection/run-flaky-test-detection.ps1 -Iterations ${{ inputs.iterations }} -SkipRestore -SkipBuild
      timeout-minutes: ${{ inputs.timeout-minutes }}

    - name: Run flaky test detection - Linux
      if: runner.os == 'Linux'
      shell: bash
      run: bash ./scripts/run-flaky-test-detection/run-flaky-test-detection.sh ${{ inputs.iterations }} --skip-restore --skip-build
      timeout-minutes: ${{ inputs.timeout-minutes }}
