name: Reusable Flaky Test Detection

on:
  workflow_call:
    inputs:
      iterations:
        description: 'Number of test iterations to run'
        required: true
        type: number
        default: 20
      timeout-minutes:
        description: 'Timeout in minutes (recommended: iterations * 3, e.g., 50 iterations = 150 minutes)'
        required: false
        type: number
        default: 100

permissions:
  contents: read

jobs:
  detect-flaky-tests:
    name: Detect Flaky Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
      fail-fast: false

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
      with:
        dotnet-version: 9.0.x

    - name: Cache NuGet packages
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ~/.nuget/packages  # Cross-platform: works on Windows, Linux, and macOS
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore NuGet packages
      run: dotnet restore Rivulet.slnx

    - name: Build solution (Release)
      run: dotnet build Rivulet.slnx -c Release --no-restore

    - name: Run flaky test detection - Windows
      if: runner.os == 'Windows'
      shell: pwsh
      run: ./scripts/run-flaky-test-detection/run-flaky-test-detection.ps1 -Iterations ${{ inputs.iterations }} -SkipRestore -SkipBuild
      timeout-minutes: ${{ inputs.timeout-minutes }}

    - name: Run flaky test detection - Linux
      if: runner.os == 'Linux'
      shell: bash
      run: bash ./scripts/run-flaky-test-detection/run-flaky-test-detection.sh ${{ inputs.iterations }} --skip-restore --skip-build
      timeout-minutes: ${{ inputs.timeout-minutes }}
