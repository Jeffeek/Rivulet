name: ReSharper Code Analysis

on:
  workflow_dispatch:
  pull_request:
    branches:
      - "master"
      - "release/**"
    paths:
      - "**.cs"
      - "**.csproj"
      - ".editorconfig"
      - ".github/workflows/resharper-analysis.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  resharper-inspect:
    name: ReSharper InspectCode
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
      with:
        dotnet-version: 9.0.x

    - name: Cache NuGet packages
      uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install ReSharper CLI Tools
      run: |
        dotnet new tool-manifest --force
        dotnet tool install JetBrains.ReSharper.GlobalTools --version 2025.3.0.4
        dotnet tool restore

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build -c Release --no-restore

    - name: Run ReSharper InspectCode
      run: |
        dotnet jb inspectcode Rivulet.sln \
          --output=resharper-report.xml \
          --format=Xml \
          --no-build \
          --properties:Configuration=Release \
          --severity=WARNING \
          --exclude=**/obj/**;**/bin/**;**/TestResults/**;**/samples/**;**/tests/** \
          --verbosity=WARN
      continue-on-error: true

    - name: Parse ReSharper Report
      id: parse-report
      run: |
        if [ ! -f resharper-report.xml ]; then
          echo "No ReSharper report generated"
          echo "issues_found=0" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Count issues (excluding INFO severity)
        ISSUES_COUNT=$(grep -c '<Issue ' resharper-report.xml || echo "0")
        echo "issues_found=$ISSUES_COUNT" >> $GITHUB_OUTPUT

        # Extract summary
        echo "## ReSharper Code Analysis Summary" > resharper-summary.md
        echo "" >> resharper-summary.md

        if [ "$ISSUES_COUNT" -eq "0" ]; then
          echo "‚úÖ No issues found! Code quality is excellent." >> resharper-summary.md
        else
          echo "‚ö†Ô∏è Found **$ISSUES_COUNT** issue(s) that need attention." >> resharper-summary.md
          echo "" >> resharper-summary.md
          echo "### Top Issues" >> resharper-summary.md

          # Extract first 10 issues
          grep '<Issue ' resharper-report.xml | head -10 | while IFS= read -r line; do
            TYPE=$(echo "$line" | sed -n 's/.*TypeId="\([^"]*\)".*/\1/p')
            FILE=$(echo "$line" | sed -n 's/.*File="\([^"]*\)".*/\1/p' | sed 's/.*\///')
            LINE_NUM=$(echo "$line" | sed -n 's/.*Line="\([^"]*\)".*/\1/p')
            MESSAGE=$(echo "$line" | sed -n 's/.*Message="\([^"]*\)".*/\1/p')

            if [ ! -z "$TYPE" ]; then
              echo "- **$TYPE** in \`$FILE:$LINE_NUM\`" >> resharper-summary.md
              if [ ! -z "$MESSAGE" ]; then
                echo "  - $MESSAGE" >> resharper-summary.md
              fi
            fi
          done

          if [ "$ISSUES_COUNT" -gt "10" ]; then
            echo "" >> resharper-summary.md
            echo "_... and $(($ISSUES_COUNT - 10)) more issues. See the full report for details._" >> resharper-summary.md
          fi
        fi

        echo "" >> resharper-summary.md
        echo "---" >> resharper-summary.md
        echo "üìä **Analysis Tool**: JetBrains ReSharper 2024.3.6" >> resharper-summary.md
        echo "üîç **Severity Level**: WARNING and above" >> resharper-summary.md

    - name: Upload ReSharper Report
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: resharper-report
        path: |
          resharper-report.xml
          resharper-summary.md
        retention-days: 7

    - name: Comment PR with Results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      with:
        script: |
          const fs = require('fs');

          let summary = '## ReSharper Code Analysis\n\n‚ÑπÔ∏è Analysis report not available.';

          try {
            if (fs.existsSync('resharper-summary.md')) {
              summary = fs.readFileSync('resharper-summary.md', 'utf8');
            }
          } catch (error) {
            console.log('Could not read summary file:', error);
          }

          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('ReSharper Code Analysis')
          );

          const commentBody = summary;

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

    - name: Check Analysis Results
      run: |
        ISSUES_COUNT="${{ steps.parse-report.outputs.issues_found }}"

        if [ "$ISSUES_COUNT" -eq "0" ]; then
          echo "‚úÖ ReSharper analysis passed - no issues found!"
          exit 0
        else
          echo "‚ö†Ô∏è ReSharper found $ISSUES_COUNT issue(s)."
          echo "Review the issues above and fix them to improve code quality."
          echo ""
          echo "Note: This is a warning, not a failure. The workflow will pass."
          echo "Consider fixing these issues to maintain high code quality standards."
          exit 0
        fi
