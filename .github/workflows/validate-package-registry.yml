name: Validate Package Registry

on:
  pull_request:
    branches:
      - "master"
      - "release/**"
    paths:
      - 'packages.yml'
      - 'README.md'
      - 'ROADMAP.md'
      - 'samples/README.md'
      - '.github/workflows/release.yml'
      - '.github/workflows/nuget-activity-monitor.yml'
      - '.github/dependabot.yml'
      - 'scripts/UpdateAll/package_registry.py'
      - 'scripts/UpdateAll/generate-all.py'
      - '.github/workflows/validate-package-registry.yml'
  push:
    branches:
      - "master"
      - "release/**"
    paths:
      - 'packages.yml'
      - 'README.md'
      - 'ROADMAP.md'
      - 'samples/README.md'
      - '.github/workflows/release.yml'
      - '.github/workflows/nuget-activity-monitor.yml'
      - '.github/dependabot.yml'
      - 'scripts/UpdateAll/package_registry.py'
      - 'scripts/UpdateAll/generate-all.py'
      - '.github/workflows/validate-package-registry.yml'

permissions:
  contents: read

jobs:
  validate:
    name: Validate Package Registry
    runs-on: ubuntu-latest

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0

    - name: Setup Python 3.12
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Validate package registry
      run: |
        echo "========================================="
        echo "Validating package registry..."
        echo "========================================="
        python scripts/UpdateAll/package_registry.py

    - name: Check if generated files are up-to-date
      run: |
        echo ""
        echo "========================================="
        echo "Checking if generated files are up-to-date..."
        echo "========================================="
        python scripts/UpdateAll/generate-all.py --check --verbose

    - name: Validation succeeded
      if: success()
      run: |
        echo ""
        echo "✅ Package registry validation passed!"
        echo "✅ All generated files are up-to-date!"

    - name: Validation failed
      if: failure()
      run: |
        echo ""
        echo "❌ Package registry validation failed!"
        echo ""
        echo "If generated files are out of date, run:"
        echo "  ./scripts/UpdateAll/update-all.sh"
        echo ""
        echo "Then commit the changes:"
        echo "  git add packages.yml README.md samples/README.md ROADMAP.md .github/"
        echo "  git commit -m 'Update generated files'"
        exit 1
