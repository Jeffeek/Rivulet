name: Release Package

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: read

jobs:
  build-and-publish:
    name: Build and Publish NuGet Package
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        fetch-depth: 0

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
      with:
        dotnet-version: 9.0.x

    - name: Cache NuGet packages
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Restore dependencies
      run: dotnet restore

    - name: Build (Release)
      run: dotnet build -c Release --no-restore

    - name: Run tests
      run: dotnet test -c Release --no-build --verbosity normal
      timeout-minutes: 5

    - name: Pack NuGet packages
      run: |
        # PACK_COMMANDS_START
        dotnet pack src/Rivulet.Core/Rivulet.Core.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Diagnostics/Rivulet.Diagnostics.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Diagnostics.OpenTelemetry/Rivulet.Diagnostics.OpenTelemetry.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Hosting/Rivulet.Hosting.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Testing/Rivulet.Testing.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Http/Rivulet.Http.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.IO/Rivulet.IO.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql/Rivulet.Sql.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql.SqlServer/Rivulet.Sql.SqlServer.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql.PostgreSql/Rivulet.Sql.PostgreSql.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql.MySql/Rivulet.Sql.MySql.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Polly/Rivulet.Polly.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        # PACK_COMMANDS_END
      timeout-minutes: 20

    - name: List artifacts
      run: ls -la ./artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2.4.2
      with:
        files: ./artifacts/*.nupkg
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}  # Mark as prerelease if version contains '-' (e.g., 1.0.0-beta)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts to workflow
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: nuget-packages-${{ steps.get_version.outputs.version }}
        path: ./artifacts/*.nupkg
        retention-days: 30

    - name: Publish to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
