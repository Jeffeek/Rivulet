name: Release Package

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: read

jobs:
  build-and-publish:
    name: Build and Publish NuGet Package
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
      with:
        dotnet-version: 9.0.x

    - name: Cache NuGet packages
      uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Restore dependencies
      run: dotnet restore

    - name: Build (Release)
      run: dotnet build Rivulet.slnx -c Release --no-restore

    - name: Run tests
      run: dotnet test Rivulet.slnx -c Release --no-build --verbosity normal
      timeout-minutes: 5

    - name: Pack NuGet packages
      run: |
        # PACK_COMMANDS_START
        dotnet pack src/Rivulet.Core/Rivulet.Core.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Diagnostics/Rivulet.Diagnostics.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Diagnostics.OpenTelemetry/Rivulet.Diagnostics.OpenTelemetry.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Hosting/Rivulet.Hosting.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Testing/Rivulet.Testing.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Http/Rivulet.Http.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.IO/Rivulet.IO.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql/Rivulet.Sql.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql.SqlServer/Rivulet.Sql.SqlServer.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql.PostgreSql/Rivulet.Sql.PostgreSql.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Sql.MySql/Rivulet.Sql.MySql.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Polly/Rivulet.Polly.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Csv/Rivulet.Csv.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        dotnet pack src/Rivulet.Pipeline/Rivulet.Pipeline.csproj -c Release --output ./artifacts -p:PackageVersion=${{ steps.get_version.outputs.version }}
        # PACK_COMMANDS_END
      timeout-minutes: 20

    - name: List artifacts
      run: ls -la ./artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        files: ./artifacts/*.nupkg
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}  # Mark as prerelease if version contains '-' (e.g., 1.0.0-beta)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts to workflow
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: nuget-packages-${{ steps.get_version.outputs.version }}
        path: ./artifacts/*.nupkg
        retention-days: 30

    - name: Publish to NuGet.org
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
